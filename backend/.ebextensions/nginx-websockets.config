# This file configures the Nginx web server for Daphne and WebSockets.
# It should be placed in the .ebextensions directory.

files:
  "/etc/nginx/conf.d/websockets.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      # Define the upstream server as Daphne, listening on port 8000.
      upstream daphne {
          server 127.0.0.1:8000;
      }
      
      server {
          listen 80;
      
          # Serve static files directly.
          location /static/ {
              alias /var/app/current/staticfiles/;
              expires 1y;
              add_header Cache-Control public;
          }
      
          # Serve media files directly.
          location /media/ {
              alias /var/app/current/media/;
              expires 1y;
              add_header Cache-Control public;
          }
      
          # Proxy all other requests to the Daphne server.
          location / {
              proxy_pass http://daphne;
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
      
              # Headers required for WebSocket traffic.
              proxy_http_version 1.1;
              proxy_set_header Upgrade $http_upgrade;
              proxy_set_header Connection "upgrade";
      
              # Long timeouts for long-running WebSocket connections.
              proxy_read_timeout 86400;
              proxy_send_timeout 86400;
          }
      }

container_commands:
  # Remove the default Nginx configuration to prevent conflicts.
  01_remove_default_nginx:
    command: "rm -f /etc/nginx/conf.d/000_default.conf"
  # Restart Nginx to apply the new configuration.
  02_restart_nginx:
    command: "service nginx restart"
